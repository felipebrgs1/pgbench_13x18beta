# PostgreSQL 13 vs 18 Beta3 - Benchmark Completo

Este repositÃ³rio contÃ©m um setup completo para comparar a performance entre PostgreSQL 13 e PostgreSQL 18 Beta3 utilizando Docker Compose, pgbench, e monitoramento com Prometheus.

## ğŸ¯ Objetivo

Realizar um benchmark abrangente comparando:
- **Throughput** (TPS - TransaÃ§Ãµes por segundo)
- **LatÃªncia** mÃ©dia das consultas
- **Uso de CPU e MemÃ³ria**
- **EficiÃªncia de I/O**
- **Performance de diferentes tipos de workload**

## ğŸ“‹ PrÃ©-requisitos

- **Docker** >= 20.10
- **Docker Compose** >= 1.29
- **Pelo menos 4GB RAM disponÃ­vel**
- **Pelo menos 2 CPU cores**
- **10GB espaÃ§o em disco livre**

## ğŸ—ï¸ Arquitetura do Benchmark

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚    â”‚   PostgreSQL    â”‚    â”‚   pgbench       â”‚
â”‚       13        â”‚    â”‚    18 Beta3     â”‚    â”‚   Runner        â”‚
â”‚   (Port 5432)   â”‚    â”‚   (Port 5433)   â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Prometheus    â”‚    â”‚   PG Exporter   â”‚    â”‚   PG Exporter   â”‚
    â”‚   (Port 9090)   â”‚    â”‚   PG13 (9187)   â”‚    â”‚   PG18 (9188)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ Como Executar

### 1. PreparaÃ§Ã£o dos Arquivos

Crie a seguinte estrutura de diretÃ³rios e coloque os arquivos nos locais corretos:

```bash
postgres-benchmark/
â”œâ”€â”€ docker compose.yml
â”œâ”€â”€ postgresql.conf
â”œâ”€â”€ prometheus.yml
â”œâ”€â”€ run_postgres_benchmark.sh
â”œâ”€â”€ benchmark-scripts/
â”‚   â”œâ”€â”€ run_benchmarks.sh
â”‚   â””â”€â”€ generate_report.sh
â”œâ”€â”€ init-scripts/
â”‚   â””â”€â”€ 01_init.sql
â”œâ”€â”€ benchmark-results/
â””â”€â”€ README.md
```

### 2. Tornar Scripts ExecutÃ¡veis

```bash
chmod +x run_postgres_benchmark.sh
chmod +x benchmark-scripts/*.sh
```

### 3. ExecuÃ§Ã£o AutomÃ¡tica (Recomendado)

```bash
./run_postgres_benchmark.sh
```

### 4. ExecuÃ§Ã£o Manual

Se preferir controle manual:

```bash
# Iniciar serviÃ§os
docker compose up -d

# Aguardar containers ficarem prontos (2-3 minutos)
docker compose logs -f postgres13 postgres18

# Executar benchmarks
docker compose exec pgbench-runner /benchmark-scripts/run_benchmarks.sh

# Parar serviÃ§os
docker compose down
```

## ğŸ“Š Tipos de Teste

### 1. Standard Test (TPC-B Like)
- **DescriÃ§Ã£o**: Workload OLTP tÃ­pico com mix de operaÃ§Ãµes
- **OperaÃ§Ãµes**: SELECT, INSERT, UPDATE, transaÃ§Ãµes complexas
- **Uso**: Simula aplicaÃ§Ãµes reais com carga mista

### 2. Read-Only Test
- **DescriÃ§Ã£o**: Apenas operaÃ§Ãµes SELECT
- **OperaÃ§Ãµes**: Consultas de leitura otimizadas
- **Uso**: Testa performance de consultas e otimizaÃ§Ãµes do planner

### 3. Prepared Statements Test
- **DescriÃ§Ã£o**: TPC-B usando prepared statements
- **OperaÃ§Ãµes**: Mesmas do standard, mas com statements preparados
- **Uso**: Testa eficiÃªncia do cache de statements e parsing

## ğŸ“ˆ Monitoramento em Tempo Real

Durante a execuÃ§Ã£o, vocÃª pode monitorar:

- **Prometheus**: http://localhost:9090
- **MÃ©tricas PG13**: http://localhost:9187/metrics
- **MÃ©tricas PG18**: http://localhost:9188/metrics

### Queries Ãšteis no Prometheus

```promql
# Taxa de transaÃ§Ãµes por segundo
rate(pg_stat_database_xact_commit_total[5m])

# ConexÃµes ativas
pg_stat_activity_count{state="active"}

# Cache hit ratio
pg_stat_database_blks_hit / (pg_stat_database_blks_hit + pg_stat_database_blks_read)

# Tempo mÃ©dio de consulta
rate(pg_stat_statements_mean_time_ms[5m])
```

## ğŸ“‹ ConfiguraÃ§Ãµes de Performance

### PostgreSQL otimizado para benchmark:
- **shared_buffers**: 512MB
- **effective_cache_size**: 1GB  
- **work_mem**: 16MB
- **maintenance_work_mem**: 256MB
- **max_connections**: 200
- **checkpoint_completion_target**: 0.9

### Recursos Docker:
- **CPU**: 2 cores por container
- **MemÃ³ria**: 2GB por container
- **Limits**: Controlados via Docker Compose

## ğŸ“Š Interpretando os Resultados

### Arquivo de RelatÃ³rio Principal
```
benchmark-results/benchmark_summary_YYYYMMDD_HHMMSS.md
```

### MÃ©tricas Principais

1. **TPS (Transactions Per Second)**
   - Maior = melhor performance
   - Compare entre os tipos de teste

2. **LatÃªncia MÃ©dia**
   - Menor = melhor responsividade
   - Importante para aplicaÃ§Ãµes interativas

3. **Uso de Recursos**
   - CPU: % de utilizaÃ§Ã£o
   - MemÃ³ria: padrÃµes de consumo
   - I/O: operaÃ§Ãµes de disco

### Exemplo de Resultado Esperado

```markdown
| Test Type | PostgreSQL 13 | PostgreSQL 18 | Improvement |
|-----------|---------------|---------------|-------------|
| standard  | 1250.5        | 1387.2        | +10.9%      |
| readonly  | 8934.1        | 9876.5        | +10.5%      |
| prepared  | 1456.8        | 1623.4        | +11.4%      |
```

## ğŸ”§ PersonalizaÃ§Ã£o

### Ajustar ParÃ¢metros do Benchmark

Edite `benchmark-scripts/run_benchmarks.sh`:

```bash
SCALE_FACTOR=50     # Tamanho da base (50 = ~750MB)
THREADS=4           # Threads do pgbench
CLIENTS=20          # ConexÃµes simultÃ¢neas
DURATION=300        # DuraÃ§Ã£o em segundos
```

### Modificar ConfiguraÃ§Ã£o PostgreSQL

Edite `postgresql.conf` para ajustar:
- MemÃ³ria (shared_buffers, work_mem)
- Checkpoints
- WAL settings
- Logging levels

### Adicionar Testes Customizados

Crie scripts SQL em `init-scripts/` para:
- Tabelas de teste especÃ­ficas
- Ãndices customizados
- FunÃ§Ãµes de benchmark

## ğŸ› Troubleshooting

### Container nÃ£o inicia
```bash
# Verificar logs
docker compose logs postgres13
docker compose logs postgres18

# Verificar recursos
docker system df
```

### Benchmark falha
```bash
# Verificar conectividade
docker compose exec pgbench-runner pg_isready -h postgres13 -p 5432
docker compose exec pgbench-runner pg_isready -h postgres18 -p 5432

# Verificar permissÃµes
ls -la benchmark-scripts/
```

### Performance muito baixa
- Aumentar recursos Docker
- Verificar se hÃ¡ outros containers consumindo recursos
- Ajustar `SCALE_FACTOR` para menor valor

### Erro de memÃ³ria
```bash
# Reduzir configuraÃ§Ãµes
# Em postgresql.conf:
shared_buffers = 256MB
work_mem = 8MB
```

## ğŸ“ Estrutura de Arquivos Gerados

```
benchmark-results/
â”œâ”€â”€ benchmark_summary_20241215_143022.md      # RelatÃ³rio principal
â”œâ”€â”€ pgbench_13_standard_20241215_143022.log   # Logs detalhados PG13
â”œâ”€â”€ pgbench_18_standard_20241215_143022.log   # Logs detalhados PG18
â”œâ”€â”€ system_stats_13_20241215_143022.log       # Stats sistema PG13
â”œâ”€â”€ system_stats_18_20241215_143022.log       # Stats sistema PG18
â”œâ”€â”€ table_stats_pg13_20241215_143022.log      # EstatÃ­sticas tabelas PG13
â”œâ”€â”€ table_stats_pg18_20241215_143022.log      # EstatÃ­sticas tabelas PG18
â””â”€â”€ query_stats_pg13_20241215_143022.log      # Top queries PG13
```

## ğŸ§¹ Limpeza

### Parar serviÃ§os mantendo dados
```bash
docker compose stop
```

### Parar e remover containers mantendo volumes
```bash
docker compose down
```

### Limpeza completa (remove tudo)
```bash
docker compose down -v
docker system prune -f --volumes
```

## âš¡ Quick Start

Para executar rapidamente:

```bash
# Clone ou baixe os arquivos
git clone <repo> postgres-benchmark
cd postgres-benchmark

# Execute
./run_postgres_benchmark.sh

# Aguarde (~20-30 minutos)
# Resultados em: benchmark-results/
```

## ğŸ“ Notas Importantes

1. **Primeira execuÃ§Ã£o**: Pode demorar mais devido ao download das imagens Docker
2. **Recursos**: Certifique-se de ter recursos suficientes disponÃ­veis
3. **Dados persistentes**: Os volumes Docker mantÃªm dados entre execuÃ§Ãµes
4. **CustomizaÃ§Ã£o**: Todos os parÃ¢metros podem ser ajustados conforme necessÃ¡rio
5. **ProduÃ§Ã£o**: Este setup Ã© para teste/desenvolvimento, nÃ£o produÃ§Ã£o

## ğŸ¤ ContribuiÃ§Ã£o

Para melhorias ou problemas:
1. Crie uma issue descrevendo o problema
2. Proponha melhorias nos scripts
3. Compartilhe resultados de diferentes ambientes

---

**Autor**: Benchmark PostgreSQL Setup  
**VersÃ£o**: 1.0  
**Data**: Dezembro 2024